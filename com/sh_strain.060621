#!/bin/csh 

if ( $#argv == 0) then
echo "  "
echo " Script to read a 13-column velocity file and calculate various strain components on a map."
echo " "
echo " Basic usage : $0:t my_velocities.vel"
echo                ""
echo "               $0:t ~/gg/Calif_example/eq_disp.globk_vel_021102c.org.vel"
echo "  "
exit
endif

set VFILE = $1
set TAG = $VFILE:h
set OUT = $VFILE:t.str.ps

# delete headers
grep -v deg $VFILE | grep -v Lat | awk 'NF==13{print $0}' >! tmp.vel



# for deg
set PROJ = -JM15
set GRDSTEPX = 0.1
set GRDSTEPY = 0.1
set TICKS = -Bf10ma60m/WeSn
set RANGES = `minmax -I0.1/0.1 tmp.vel`

if (-e .gmtdefaults) \rm -f .gmtdefaults
gmtset PAPER_MEDIA letter+
gmtset MEASURE_UNIT cm
gmtset DEGREE_FORMAT 3
gmtset TICK_LENGTH 0.2
gmtset ANOT_FONT_SIZE 12
gmtset LABEL_FONT_SIZE  12
gmtset HEADER_FONT_SIZE 12
gmtset BASEMAP_TYPE FANCY
gmtset VERBOSE TRUE


# Extract velocities in proper format for psvelo
awk 'NF == 13 {print " ",$1,$2,$3,$4,$7,$8,$9}' tmp.vel >! tmp.velo 

# make Delaunay triangles
#awk 'NR > 3{print $1,$2}' $VFILE | sort -n | triangulate -H0 $RANGES -M $PROJ | mapproject $PROJ $RANGES -I -M >! tmp.res
awk 'NF == 13{print $1,$2}' tmp.vel |  triangulate -H0 $RANGES -M $PROJ -I$GRDSTEPX/$GRDSTEPY  >! tmp.res

# East Velocity in mm/yr
awk 'NF == 13 {print $1,$2,$3}' tmp.vel | triangulate -H0 $RANGES $PROJ -I$GRDSTEPX/$GRDSTEPY -Ge.grd 
grdedit e.grd -Ddeg/deg/mm_per_yr/1./0./east_velocity/$TAG
grdinfo e.grd

# North Velocity in mm/yr
awk 'NF == 13 {print $1,$2,$4}' tmp.vel | triangulate -H0 $RANGES $PROJ -I$GRDSTEPX/$GRDSTEPY -Gn.grd 
grdedit n.grd -Ddeg/deg/mm_per_yr/1./0./north_velocity/$TAG
grdinfo n.grd

# Upward Velocity in mm/yr
awk 'NF == 13 {print $1,$2,$10}' tmp.vel | triangulate -H0 $RANGES $PROJ -I$GRDSTEPX/$GRDSTEPY -Gu.grd 
grdedit u.grd -Ddeg/deg/mm_per_yr/1./0./up_velocity/$TAG
grdinfo u.grd

# gradients in ppm/yr
# mm/yr/m * -1.e3 
# The minus sign is because of the following "gotcha" in grdgradient:
#     derivative is negated so that grdgradient will give positive
#     values when the slope of z(x,y)  is  downhill  in  the  azim
#     direction.  


grdgradient e.grd -A90. -Gtmp.grd -M
grdmath tmp.grd -1.e3 MUL = dvede.grd
grdedit dvede.grd -D=/=/ppm_per_yr/=/=/"Eastward gradient of East component"/=
grdinfo dvede.grd

grdgradient n.grd -A90. -Gtmp.grd -M
grdmath tmp.grd -1.e3 MUL = dvnde.grd
grdedit dvnde.grd -D=/=/ppm_per_yr/=/=/"Eastward gradient of North component"/=
grdinfo dvnde.grd

grdgradient e.grd -A0. -Gtmp.grd -M
grdmath tmp.grd -1.e3 MUL = dvedn.grd
grdedit dvedn.grd -D=/=/ppm_per_yr/=/=/"Northward gradient of East component"/=
grdinfo dvedn.grd

grdgradient n.grd -A0. -Gtmp.grd -M
grdmath tmp.grd -1.e3 MUL = dvndn.grd
grdedit dvndn.grd -D=/=/ppm_per_yr/=/=/"Northward gradient of North component"/=
grdinfo dvndn.grd

grdmath dvede.grd dvndn.grd ADD = dil.grd
grdedit dil.grd -D=/=/ppm_per_yr/=/=/"Areal dilatation"/=

grdmath dvedn.grd dvnde.grd SUB = rot.grd
grdedit rot.grd -D=/=/ppm_per_yr/=/=/"Clockwise Spin rate"/=

grdmath dvede.grd dvndn.grd SUB = gam1.grd
grdedit gam1.grd -D=/=/microrad_per_yr/=/=/"Gamma 1"/=

grdmath dvnde.grd dvedn.grd ADD = gam2.grd
grdedit gam2.grd -D=/=/microrad_per_yr/=/=/"Gamma 2"/=

grdmath gam1.grd gam2.grd HYPOT = gamt.grd
grdedit gamt.grd -D=/=/microrad_per_yr/=/=/"Gamma Total"/=

gmtset D_FORMAT %.2lf ; grd2cpt e.grd >! tmp.cpt
grdimage e.grd -Ctmp.cpt $PROJ $TICKS/":.East Velocity in mm/yr:"/WeSn -P -K -X3 -Y3 >! $OUT
psscale -Ctmp.cpt -D15/8/10/1 -K -O -P >> $OUT

#psvelo tmp.velo -Se0.05/0.95/9 $PROJ $RANGES -A0.05/0.15/0.07 -V -O -K -P >> $OUT
psxy tmp.res $PROJ $RANGES -V -M -O -U$TAG -P -K >> $OUT
psxy tmp.velo -Sc0.1 $PROJ $RANGES -G255 -V -O  -P >> $OUT

gmtset D_FORMAT %.2lf ; grd2cpt n.grd >! tmp.cpt
grdimage n.grd -Ctmp.cpt $PROJ $TICKS/":.North Velocity in mm/yr:"/WeSn -P -K  -X3 -Y3  >> $OUT
psscale -Ctmp.cpt -D15/8/10/1 -K -O >> $OUT
psvelo tmp.velo -Se0.05/0.95/9 $PROJ $RANGES -A0.05/0.15/0.07 -V -O -K -P >> $OUT
psxy tmp.res $PROJ $RANGES -M -O -U$TAG -P >> $OUT

gmtset D_FORMAT %.2lf ; grd2cpt n.grd >! tmp.cpt
grdimage u.grd -Ctmp.cpt $PROJ $TICKS/":.Upward Velocity in mm/yr:"/WeSn -P -K  -X3 -Y3  >> $OUT
psscale -Ctmp.cpt -D15/8/10/1 -K -O >> $OUT
psvelo tmp.velo -Se0.05/0.95/9 $PROJ $RANGES -A0.05/0.15/0.07 -V -O -K -P >> $OUT
psxy tmp.res $PROJ $RANGES -M -O -U$TAG -P >> $OUT

#grdimage r.grd -Cvel.cpt $PROJ $TICKS/":.Line of site comp in mm/yr:"/WeSn -P -K  -X3 -Y3  >> $OUT
#psscale -Cvel.cpt -D15/8/10/1 -K -O >> $OUT
##psvelo tmp.velo -Se0.05/0.95/9 $PROJ $RANGES -A0.05/0.15/0.07 -V -O -K -P >> $OUT
#psxy tmp.res $PROJ $RANGES -M -O -U$TAG -P >> $OUT
#
#grdimage f.grd -Cfringe.cpt $PROJ $TICKS/":.Fringes over 5 years:"/WeSn -P -K  -X3 -Y3  >> $OUT
#psscale -Cfringe.cpt -D15/8/10/1 -K -O >> $OUT
##psvelo tmp.velo -Se0.05/0.95/9 $PROJ $RANGES -A0.05/0.15/0.07 -V -O -K -P >> $OUT
#psxy tmp.res $PROJ $RANGES -M -O -U$TAG -P >> $OUT


gmtset D_FORMAT %.2lf ; grd2cpt dvede.grd > ! tmp.cpt
grdimage dvede.grd -Ctmp.cpt $PROJ $TICKS/":.E-ward grad of Ve in ppm/yr:"/WeSn -P -K  -X3 -Y3  >> $OUT
psscale -Ctmp.cpt -D15/10/18/1 -K -O >> $OUT
psxy tmp.res $PROJ $RANGES -M -O -U$TAG -P >> $OUT

gmtset D_FORMAT %.2lf ; grd2cpt dvnde.grd > ! tmp.cpt
grdimage dvnde.grd -Ctmp.cpt $PROJ $TICKS/":.E-ward grad of Vn in ppm/yr:"/WeSn -P -K  -X3 -Y3  >> $OUT
psscale -Ctmp.cpt -D15/10/18/1 -K -O >> $OUT
psxy tmp.res $PROJ $RANGES -M -O -U$TAG -P >> $OUT

gmtset D_FORMAT %.2lf ; grd2cpt dvedn.grd > ! tmp.cpt
grdimage dvedn.grd -Ctmp.cpt $PROJ $TICKS/":.N-ward grad of Ve in ppm/yr:"/WeSn -P -K  -X3 -Y3  >> $OUT
psscale -Ctmp.cpt -D15/10/18/1 -K -O >> $OUT
psxy tmp.res $PROJ $RANGES -M -O -U$TAG -P >> $OUT

gmtset D_FORMAT %.2lf ; grd2cpt dvndn.grd > ! tmp.cpt
grdimage dvndn.grd -Ctmp.cpt $PROJ $TICKS/":.N-ward grad of Vn in ppm/yr:"/WeSn -P -K  -X3 -Y3  >> $OUT
psscale -Ctmp.cpt -D15/10/18/1 -K -O >> $OUT
psxy tmp.res $PROJ $RANGES -M -O -U$TAG -P >> $OUT

gmtset D_FORMAT %.2lf ; grd2cpt dil.grd > ! tmp.cpt
grdimage dil.grd -Ctmp.cpt $PROJ $TICKS/":.Areal dilatation in ppm/yr:"/WeSn -P -K  -X3 -Y3  >> $OUT
psscale -Ctmp.cpt -D15/10/18/1 -K -O >> $OUT
psxy tmp.res $PROJ $RANGES -M -O -U$TAG -P >> $OUT

gmtset D_FORMAT %.2lf ; grd2cpt rot.grd > ! tmp.cpt
grdimage rot.grd -Ctmp.cpt $PROJ $TICKS/":.Clockwise Spin Rate in ppm/yr:"/WeSn -P -K  -X3 -Y3  >> $OUT
psscale -Ctmp.cpt -D15/10/18/1 -K -O >> $OUT
psxy tmp.res $PROJ $RANGES -M -O -U$TAG -P >> $OUT

gmtset D_FORMAT %.2lf ; grd2cpt gam1.grd > ! tmp.cpt
grdimage gam1.grd -Ctmp.cpt $PROJ $TICKS/":.Gamma1 in microrad/yr:"/WeSn -P -K  -X3 -Y3  >> $OUT
psscale -Ctmp.cpt -D15/10/18/1 -K -O >> $OUT
psxy tmp.res $PROJ $RANGES -M -O -U$TAG -P >> $OUT

gmtset D_FORMAT %.2lf ; grd2cpt gam2.grd > ! tmp.cpt
grdimage gam2.grd -Ctmp.cpt $PROJ $TICKS/":.Gamma2 in microrad/yr:"/WeSn -P -K  -X3 -Y3  >> $OUT
psscale -Ctmp.cpt -D15/10/18/1 -K -O >> $OUT
psxy tmp.res $PROJ $RANGES -M -O -U$TAG -P >> $OUT

gmtset D_FORMAT %.2lf ; grd2cpt gamt.grd > ! tmp.cpt
grdimage gamt.grd -Ctmp.cpt $PROJ $TICKS/":.Gamma Total in microrad/yr:"/WeSn -P -K  -X3 -Y3  >> $OUT
psscale -Ctmp.cpt -D15/10/18/1 -K -O >> $OUT
psxy tmp.res $PROJ $RANGES -M -O -U$TAG -P >> $OUT




gs $OUT



